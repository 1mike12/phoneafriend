<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<video id="1" autoplay style="width: 25%"></video>
<video id="1-other" autoplay style="width: 50%"></video>
<video id="2" autoplay style="width: 25%"></video>
<video id="2-other" autoplay style="width: 50%"></video>

<button id="1-submit">1 Send Text</button>
<button id="2-submit">2 Send Text</button>

<script src="https://cdn.jsdelivr.net/npm/socket.io-client@2.0.3/dist/socket.io.js"></script>
<script type="application/javascript">
    const UUID = 1;

    class Socket {
        constructor(id, token){
            this.id = id;
            this.token = token;
            this.caller = false;

            let socket = io("http://localhost:9009", {
                query: `token=${this.token}`
            });

            let pc = new RTCPeerConnection({"iceServers": [{"url": "stun:stun.l.google.com:19302"}]});

            pc.onicecandidate = (e) =>{
                socket.emit('NEW_ICE_CANDIDATE', {candidate: e.candidate, userId: this.id, uuid: UUID})
            };

            pc.onaddstream = (e) =>{
                let remoteVideo = document.getElementById(this.id + "-other");
                remoteVideo.srcObject = e.stream;
            };

            pc.oniceconnectionstatechange = (e) =>{
                if (e.target.iceConnectionState === 'connected'){
                    if (this.caller) this.createDataChannel();

                }
            };

            pc.ondatachannel = (e) =>{
                console.log("on data channel", e)
            };

            this.pc = pc;

            socket.on("connect", () =>{
                socket.emit("joinRoom", {uuid: UUID});

                socket.on("userJoinedRoom", (othersInRoom) =>{
                    this.caller = true;
                    if (othersInRoom.length > 0){
                        this.addVideo()
                        .then(() => this.createOffer());
                    }
                })
            });

            socket.on('VIDEO_OFFER', (res) =>{
                let {userId, description} = res;
                this.createAnswer(userId, description)

            });

            socket.on("VIDEO_ANSWER", (res) =>{
                this.handleAnswer(res.description);
            });

            socket.on("NEW_ICE_CANDIDATE", (res) =>{
                let {candidate} = res;
                try {
                    let rtcCandidate = new RTCIceCandidate(candidate);
                    this.pc.addIceCandidate(rtcCandidate);
                } catch (e) {
                    console.log(e)
                }

            });

            this.socket = socket;
        }

        createAnswer(userId, description){
            let desc = new RTCSessionDescription(description);
            this.pc.setRemoteDescription(desc);

            return this.addVideo()
            .then(() => this.pc.createAnswer())
            .then(localDescription =>{
                this.pc.setLocalDescription(localDescription);
                this.socket.emit("VIDEO_ANSWER", {uuid: UUID, description: localDescription})
            })
            .catch(e =>{
                throw e;
            })
        }

        handleAnswer(desc){
            let description = new RTCSessionDescription(desc);
            this.pc.setRemoteDescription(description)
        }

        createDataChannel(){
            console.log("createDataChannel")
            let pc = this.pc;
            if (pc.textDataChannel){
                return;
            }

            let dataChannel = pc.createDataChannel("text", {});

            dataChannel.onerror = function(error){
                console.log("dataChannel.onerror", error);
            };

            dataChannel.onmessage = function(event){
                console.log("dataChannel.onmessage:", event.data);
            };

            dataChannel.onopen = function(){
                console.log('dataChannel.onopen');
            };

            dataChannel.onclose = function(){
                console.log("dataChannel.onclose");
            };

            pc.textDataChannel = dataChannel;

            let button = document.getElementById(this.id + "-submit");
            button.onclick = () =>{
                pc.textDataChannel.send("hello")
            }
        }

        createOffer(){
            return this.pc.createOffer()
            .then(description =>{
                this.pc.setLocalDescription(description);
                this.socket.emit("VIDEO_OFFER", {uuid: UUID, description})
            })
        }

        addVideo(){
            return navigator.mediaDevices.getUserMedia({
                audio: true,
                video: true
            })
            .then(stream =>{
                this.pc.addStream(stream);
                let video = document.getElementById(this.id);
                video.srcObject = stream;
            })
        }

    }

    let socket1 = new Socket("1", "eyJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOjExNDF9.FhKsOogaLFJBixiZWOZWnZDyfPXMANSG7dBA96CyhIM");
    let socket2 = new Socket('2', "eyJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOjJ9.7pWxwmRmTcOnCzrLd2brSrRxKuQuWSnp_X9ewmwJxk4")
</script>
</body>
</html>